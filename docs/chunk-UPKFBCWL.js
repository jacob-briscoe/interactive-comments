import{b as Y,h as E,i as D}from"./chunk-PMFX43AT.js";import{u as Z,v as ee}from"./chunk-LHKFC7MU.js";import{k as W,m as X}from"./chunk-AWTLPLDO.js";import{F as B,Ga as h,H as N,P as z,R as T,U as w,Xa as v,Za as x,_ as u,ab as V,bb as G,cb as S,da as y,db as R,eb as c,fb as _,g as P,gb as f,hb as F,j as k,kb as b,lb as r,n as I,na as p,o as M,oa as l,ta as q,ub as H,vb as O,x as L,xb as J,yb as K,zb as Q}from"./chunk-27TSPRTB.js";import{a as d,b as C,c as A}from"./chunk-35PI25VP.js";var te=(()=>{let o=class o{};o.\u0275fac=function(t){return new(t||o)},o.\u0275cmp=y({type:o,selectors:[["app-comment-loading-placeholder"]],standalone:!0,features:[O],decls:10,vars:0,consts:[[1,"shadow","rounded-md","p-4","w-full","mx-auto"],[1,"animate-pulse","flex","space-x-4"],[1,"rounded-full","bg-slate-300","h-10","w-10"],[1,"flex-1","space-y-6","py-1"],[1,"h-2","bg-slate-300","rounded"],[1,"space-y-3"],[1,"grid","grid-cols-3","gap-4"],[1,"h-2","bg-slate-300","rounded","col-span-2"],[1,"h-2","bg-slate-300","rounded","col-span-1"]],template:function(t,n){t&1&&(c(0,"div",0)(1,"div",1),f(2,"div",2),c(3,"div",3),f(4,"div",4),c(5,"div",5)(6,"div",6),f(7,"div",7)(8,"div",8),_(),f(9,"div",4),_()()()())},encapsulation:2,changeDetection:0});let i=o;return i})();var ne=(()=>{let o=class o{getComments(e){let t={currentUser:E.currentUser,comments:[]};return e.username===t.currentUser.username&&Object.assign(t.comments,E.comments),k(t).pipe(B(1500))}};o.\u0275fac=function(t){return new(t||o)},o.\u0275prov=w({token:o,factory:o.\u0275fac,providedIn:"root"});let i=o;return i})();var me={comments:{},commentsOrder:[],replies:{},repliesOrder:{},loadingComments:!1,editing:{isEditing:!1}},$=(()=>{let o=class o{constructor(){this.userStore=u(D),this.commentsService=u(ne),this.state=new P(me),this.state$=this.state.asObservable(),this.userStore.user$.pipe(L(e=>!!e),T(()=>this.setLoadingComments(!0)),z(e=>this.commentsService.getComments(e).pipe(I(({comments:t})=>this.transformAPICommentsToState(t)),T(t=>{this.state.next(d(d({},this.state.getValue()),t))}),N(()=>this.setLoadingComments(!1))))).subscribe(),this.vm$=M([this.state$,this.userStore.user$]).pipe(I(([e,t])=>({comments:this.sortedComments(e),user:t,loadingComments:e.loadingComments,editing:e.editing})))}setLoadingComments(e){this.state.next(C(d({},this.state.getValue()),{loadingComments:e}))}upvote(e){this.performUpvoteOrDownvote("up",e)}downvote(e){this.performUpvoteOrDownvote("down",e)}upvoteReply(e){this.performUpvoteOrDownvoteReply("up",e)}downvoteReply(e){this.performUpvoteOrDownvoteReply("down",e)}submitComment(e){let t=this.state.getValue();t.comments[Date.now()]={content:e,createdAt:Date.now(),score:0,user:this.userStore.loggedInUser},t.commentsOrder=this.getCommentsOrder(t.comments),this.state.next(t)}deleteComment(e){let t=this.state.getValue();delete t.comments[e],t.commentsOrder=this.getCommentsOrder(t.comments),this.state.next(t)}updateComment({id:e,content:t}){let n=this.state.getValue();n.comments[e].content=t,n.editing={isEditing:!1},this.state.next(n)}replyComment({id:e}){let t=this.state.getValue(),n=Date.now();t.replies[e]=C(d({},t.replies[e]),{[n]:{commentId:e,content:"",createdAt:Date.now(),user:this.userStore.loggedInUser,score:0,replyingTo:t.comments[e].user.username}}),t.repliesOrder=this.getRepliesOrder(t.replies),t.editing={isEditing:!0,commentId:e,replyId:n},this.state.next(t)}updateReplyComment(e){if("commentId"in e){let t=this.state.getValue();t.replies[e.commentId][e.id].content=e.content,t.editing={isEditing:!1},this.state.next(t)}else this.updateComment(e)}editComment(e){let t=this.state.getValue();t.editing={isEditing:!0,commentId:e.commentId,replyId:e.replyId},this.state.next(t)}deleteReplyComment(e){let t=this.state.getValue();delete t.replies[e.commentId][e.replyId],t.repliesOrder[e.commentId]=t.repliesOrder[e.commentId].filter(n=>n!==e.replyId),this.state.next(t)}performUpvoteOrDownvote(e,{id:t}){let n=this.state.getValue(),s=n.comments[t];s.score=this.vote(e,s.score),n.commentsOrder=this.getCommentsOrder(n.comments),this.state.next(n)}performUpvoteOrDownvoteReply(e,{id:t,replyId:n}){let s=this.state.getValue(),a=s.replies[t][n];a.score=this.vote(e,a.score),this.state.next(s)}vote(e,t){return t+(e==="up"?1:-1)}transformAPICommentsToState(e){let t=this.transformAPIComments(e),n=this.transformAPIReplies(e);return{comments:t,commentsOrder:this.getCommentsOrder(t),replies:n,repliesOrder:this.getRepliesOrder(n)}}transformAPIComments(e){return e.reduce((t,n)=>C(d({},t),{[n.id]:d({},n)}),{})}transformAPIReplies(e){return Object.entries(e).reduce((t,[n,s])=>C(d({},t),{[+n]:s.replies.reduce((a,Ce)=>{var j=Ce,{id:g}=j,ie=A(j,["id"]);return C(d({},a),{[g]:C(d({},ie),{commentId:+n})})},{})}),{})}getCommentsOrder(e){return Object.entries(e).sort(([,{score:t}],[,{score:n}])=>n-t).map(([t])=>+t)}getRepliesOrder(e){return Object.entries(e).reduce((t,[n,s])=>C(d({},t),{[n]:Object.entries(s).sort(([,{createdAt:a}],[,{createdAt:g}])=>a-g).map(([a])=>+a)}),{})}sortedComments({comments:e,commentsOrder:t,replies:n,repliesOrder:s}){return t.map(a=>C(d({id:a},e[a]),{replies:s[a]?s[a].map(g=>C(d({},n[a][g]),{id:g,commentId:a})):[]}))}};o.\u0275fac=function(t){return new(t||o)},o.\u0275prov=w({token:o,factory:o.\u0275fac});let i=o;return i})();var oe=(i,o)=>o.id,re=(i,o)=>({"w-full":i,"w-3/4":o});function se(i,o){if(i&1){let m=F();c(0,"app-comment",6),b("upVote",function(t){p(m);let n=r(2).$implicit,s=r(3);return l(s.onReplyUpvote(n.id,t))})("downVote",function(t){p(m);let n=r(2).$implicit,s=r(3);return l(s.onReplyDownvote(n.id,t))})("update",function(t){p(m);let n=r(5);return l(n.onUpdateReplyComment(t))})("edit",function(t){p(m);let n=r(5);return l(n.onEditComment(t))})("deleteReply",function(t){p(m);let n=r(5);return l(n.onDeleteReplyComment(t))})("reply",function(t){p(m);let n=r(5);return l(n.onReplyComment(t))}),_()}if(i&2){let m=o.$implicit,e=r(2).$implicit,t=r(2);x("comment",m)("myComment",m.user.username===t.user.username)("isEditing",t.editing.isEditing&&t.editing.commentId===e.id&&t.editing.replyId===m.id)}}function ae(i,o){if(i&1&&(c(0,"div",3)(1,"div",4),f(2,"hr",5),_(),c(3,"div",0),S(4,se,1,3,"app-comment",null,oe),_()()),i&2){let m=r().$implicit;h(4),R(m.replies)}}function pe(i,o){if(i&1){let m=F();c(0,"app-comment",2),b("upVote",function(t){p(m);let n=r(3);return l(n.onUpvote(t))})("downVote",function(t){p(m);let n=r(3);return l(n.onDownvote(t))})("reply",function(t){p(m);let n=r(3);return l(n.onReplyComment(t))})("delete",function(t){p(m);let n=r(3);return l(n.onDeleteComment(t))})("update",function(t){p(m);let n=r(3);return l(n.onUpdateComment(t))})("edit",function(t){p(m);let n=r(3);return l(n.onEditComment(t))}),_(),v(1,ae,6,0,"div",3)}if(i&2){let m=o.$implicit,e=r(2);x("comment",m)("myComment",m.user.username===e.user.username)("isEditing",e.editing.isEditing&&e.editing.commentId===m.id&&!e.editing.replyId),h(),V(1,m.replies.length?1:-1)}}function le(i,o){if(i&1){let m=F();S(0,pe,2,4,null,null,oe),c(2,"app-new-comment",1),b("submitComment",function(t){p(m);let n=r(2);return l(n.onSubmitComment(t))}),_()}if(i&2){let m=r();R(m.comments),h(2),x("user",m.user)}}function de(i,o){if(i&1&&(c(0,"div",7),f(1,"app-comment-loading-placeholder"),_()),i&2){let m=o.$index;x("className",J(1,re,m%2===0,m%2!==0))}}function ce(i,o){if(i&1&&S(0,de,2,4,"div",null,G),i&2){let m=r(2);R(m.placeholderComments)}}function _e(i,o){i&1&&(c(0,"div",0),v(1,le,3,1,"app-new-comment")(2,ce,2,0),_()),i&2&&(h(),V(1,o.loadingComments?2:1))}var Me=(()=>{let o=class o{constructor(){this.destroyRef=u(q),this.activatedRoute=u(Y),this.userStore=u(D),this.commentsStore=u($),this.placeholderComments=Array(5).fill(1)}ngOnInit(){}get vm$(){return this.commentsStore.vm$}onDownvote(e){this.commentsStore.downvote({id:e})}onUpvote(e){this.commentsStore.upvote({id:e})}onReplyDownvote(e,t){this.commentsStore.downvoteReply({id:e,replyId:t})}onReplyUpvote(e,t){this.commentsStore.upvoteReply({id:e,replyId:t})}onSubmitComment(e){this.commentsStore.submitComment(e)}onDeleteComment(e){this.commentsStore.deleteComment(e)}onUpdateComment(e){this.commentsStore.updateComment(e)}onReplyComment(e){this.commentsStore.replyComment(e)}onUpdateReplyComment(e){this.commentsStore.updateReplyComment(e)}onEditComment(e){this.commentsStore.editComment(e)}onDeleteReplyComment(e){this.commentsStore.deleteReplyComment(e)}};o.\u0275fac=function(t){return new(t||o)},o.\u0275cmp=y({type:o,selectors:[["app-comments"]],standalone:!0,features:[H([$]),O],decls:2,vars:3,consts:[[1,"flex","flex-col","gap-5"],[3,"submitComment","user"],[3,"upVote","downVote","reply","delete","update","edit","comment","myComment","isEditing"],[1,"flex","flex-row"],[1,"w-9","sm:w-[90px]","flex","sm:justify-center"],[1,"h-full","w-[2px]","bg-light-gray","dark:bg-dark-blue","border-0"],[3,"upVote","downVote","update","edit","deleteReply","reply","comment","myComment","isEditing"],[3,"className"]],template:function(t,n){if(t&1&&(v(0,_e,3,1,"div",0),K(1,"async")),t&2){let s;V(0,(s=Q(1,1,n.vm$))?0:-1,s)}},dependencies:[X,W,Z,ee,te],encapsulation:2,changeDetection:0});let i=o;return i})();export{Me as CommentsComponent};
