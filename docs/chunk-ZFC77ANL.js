import{a as I,b as H}from"./chunk-X5IOPJA2.js";import{u as J,v as K}from"./chunk-M2QFSZIR.js";import{k as q,m as G}from"./chunk-Q737C7W6.js";import{Fa as g,H as A,P,R as O,U as h,Xa as x,Za as w,_ as f,ab as y,bb as R,ca as k,cb as F,db as d,eb as C,fb as L,g as E,gb as V,j as U,jb as v,kb as r,ma as p,n as S,na as l,o as $,tb as M,ub as B,wb as z,x as j,xb as N}from"./chunk-I4L5JRNA.js";import{a as c,b as _,c as T}from"./chunk-KFZQC3P5.js";var W=(()=>{let o=class o{getComments(e){let t={currentUser:I.currentUser,comments:[]};return e.username===t.currentUser.username&&Object.assign(t.comments,I.comments),U(t)}};o.\u0275fac=function(t){return new(t||o)},o.\u0275prov=h({token:o,factory:o.\u0275fac,providedIn:"root"});let m=o;return m})();var Z={comments:{},commentsOrder:[],replies:{},repliesOrder:{},loadingComments:!1,editing:{isEditing:!1}},b=(()=>{let o=class o{constructor(){this.userStore=f(H),this.commentsService=f(W),this.state=new E(Z),this.state$=this.state.asObservable(),this.userStore.user$.pipe(j(e=>!!e),O(()=>this.setLoadingComments(!0)),P(e=>this.commentsService.getComments(e).pipe(S(({comments:t})=>this.transformAPICommentsToState(t)),O(t=>{this.state.next(c(c({},this.state.getValue()),t))}),A(()=>this.setLoadingComments(!1))))).subscribe(),this.vm$=$([this.state$,this.userStore.user$]).pipe(S(([e,t])=>({comments:this.sortedComments(e),user:t,loadingComments:e.loadingComments,editing:e.editing})))}setLoadingComments(e){this.state.next(_(c({},this.state.getValue()),{loadingComments:e}))}upvote(e){this.performUpvoteOrDownvote("up",e)}downvote(e){this.performUpvoteOrDownvote("down",e)}upvoteReply(e){this.performUpvoteOrDownvoteReply("up",e)}downvoteReply(e){this.performUpvoteOrDownvoteReply("down",e)}submitComment(e){let t=this.state.getValue();t.comments[Date.now()]={content:e,createdAt:Date.now(),score:0,user:this.userStore.loggedInUser},t.commentsOrder=this.getCommentsOrder(t.comments),this.state.next(t)}deleteComment(e){let t=this.state.getValue();delete t.comments[e],t.commentsOrder=this.getCommentsOrder(t.comments),this.state.next(t)}updateComment({id:e,content:t}){let n=this.state.getValue();n.comments[e].content=t,n.editing={isEditing:!1},this.state.next(n)}replyComment({id:e}){let t=this.state.getValue(),n=Date.now();t.replies[e]=_(c({},t.replies[e]),{[n]:{commentId:e,content:"",createdAt:Date.now(),user:this.userStore.loggedInUser,score:0,replyingTo:t.comments[e].user.username}}),t.repliesOrder=this.getRepliesOrder(t.replies),t.editing={isEditing:!0,commentId:e,replyId:n},this.state.next(t)}updateReplyComment(e){if("commentId"in e){let t=this.state.getValue();t.replies[e.commentId][e.id].content=e.content,t.editing={isEditing:!1},this.state.next(t)}else this.updateComment(e)}editComment(e){let t=this.state.getValue();t.editing={isEditing:!0,commentId:e.commentId,replyId:e.replyId},this.state.next(t)}deleteReplyComment(e){let t=this.state.getValue();delete t.replies[e.commentId][e.replyId],t.repliesOrder[e.commentId]=t.repliesOrder[e.commentId].filter(n=>n!==e.replyId),this.state.next(t)}performUpvoteOrDownvote(e,{id:t}){let n=this.state.getValue(),s=n.comments[t];s.score=this.vote(e,s.score),n.commentsOrder=this.getCommentsOrder(n.comments),this.state.next(n)}performUpvoteOrDownvoteReply(e,{id:t,replyId:n}){let s=this.state.getValue(),a=s.replies[t][n];a.score=this.vote(e,a.score),this.state.next(s)}vote(e,t){return t+(e==="up"?1:-1)}transformAPICommentsToState(e){let t=this.transformAPIComments(e),n=this.transformAPIReplies(e);return{comments:t,commentsOrder:this.getCommentsOrder(t),replies:n,repliesOrder:this.getRepliesOrder(n)}}transformAPIComments(e){return e.reduce((t,n)=>_(c({},t),{[n.id]:c({},n)}),{})}transformAPIReplies(e){return Object.entries(e).reduce((t,[n,s])=>_(c({},t),{[+n]:s.replies.reduce((a,me)=>{var D=me,{id:u}=D,Y=T(D,["id"]);return _(c({},a),{[u]:_(c({},Y),{commentId:+n})})},{})}),{})}getCommentsOrder(e){return Object.entries(e).sort(([,{score:t}],[,{score:n}])=>n-t).map(([t])=>+t)}getRepliesOrder(e){return Object.entries(e).reduce((t,[n,s])=>_(c({},t),{[n]:Object.entries(s).sort(([,{createdAt:a}],[,{createdAt:u}])=>a-u).map(([a])=>+a)}),{})}sortedComments({comments:e,commentsOrder:t,replies:n,repliesOrder:s}){return t.map(a=>_(c({id:a},e[a]),{replies:s[a]?s[a].map(u=>_(c({},n[a][u]),{id:u,commentId:a})):[]}))}};o.\u0275fac=function(t){return new(t||o)},o.\u0275prov=h({token:o,factory:o.\u0275fac});let m=o;return m})();var X=(m,o)=>o.id;function ee(m,o){if(m&1){let i=V();d(0,"app-comment",8),v("deleteReply",function(t){p(i);let n=r(5);return l(n.onDeleteReplyComment(t))})("downVote",function(t){p(i);let n=r(2).$implicit,s=r(3);return l(s.onReplyDownvote(n.id,t))})("edit",function(t){p(i);let n=r(5);return l(n.onEditComment(t))})("reply",function(t){p(i);let n=r(5);return l(n.onReplyComment(t))})("upVote",function(t){p(i);let n=r(2).$implicit,s=r(3);return l(s.onReplyUpvote(n.id,t))})("update",function(t){p(i);let n=r(5);return l(n.onUpdateReplyComment(t))}),C()}if(m&2){let i=o.$implicit,e=r(2).$implicit,t=r(2);w("comment",i)("myComment",i.user.username===t.user.username)("isEditing",t.editing.isEditing&&t.editing.commentId===e.id&&t.editing.replyId===i.id)}}function te(m,o){if(m&1&&(d(0,"div",4)(1,"div",5),L(2,"hr",6),C(),d(3,"div",0),R(4,ee,1,3,"app-comment",7,X),C()()),m&2){let i=r().$implicit;g(4),F(i.replies)}}function ne(m,o){if(m&1){let i=V();d(0,"app-comment",3),v("delete",function(t){p(i);let n=r(3);return l(n.onDeleteComment(t))})("downVote",function(t){p(i);let n=r(3);return l(n.onDownvote(t))})("edit",function(t){p(i);let n=r(3);return l(n.onEditComment(t))})("reply",function(t){p(i);let n=r(3);return l(n.onReplyComment(t))})("upVote",function(t){p(i);let n=r(3);return l(n.onUpvote(t))})("update",function(t){p(i);let n=r(3);return l(n.onUpdateComment(t))}),C(),x(1,te,6,0,"div",4)}if(m&2){let i=o.$implicit,e=r(2);w("comment",i)("myComment",i.user.username===e.user.username)("isEditing",e.editing.isEditing&&e.editing.commentId===i.id&&!e.editing.replyId),g(),y(i.replies.length?1:-1)}}function oe(m,o){if(m&1){let i=V();R(0,ne,2,4,null,null,X),d(2,"app-new-comment",2),v("submitComment",function(t){p(i);let n=r(2);return l(n.onSubmitComment(t))}),C()}if(m&2){let i=r();F(i.comments),g(2),w("user",i.user)}}function ie(m,o){m&1&&(d(0,"div",0),x(1,oe,3,1,"app-new-comment",1),C()),m&2&&(g(),y(o.loadingComments?-1:1))}var Se=(()=>{let o=class o{constructor(){this.commentsStore=f(b)}ngOnInit(){}get vm$(){return this.commentsStore.vm$}onDownvote(e){this.commentsStore.downvote({id:e})}onUpvote(e){this.commentsStore.upvote({id:e})}onReplyDownvote(e,t){this.commentsStore.downvoteReply({id:e,replyId:t})}onReplyUpvote(e,t){this.commentsStore.upvoteReply({id:e,replyId:t})}onSubmitComment(e){this.commentsStore.submitComment(e)}onDeleteComment(e){this.commentsStore.deleteComment(e)}onUpdateComment(e){this.commentsStore.updateComment(e)}onReplyComment(e){this.commentsStore.replyComment(e)}onUpdateReplyComment(e){this.commentsStore.updateReplyComment(e)}onEditComment(e){this.commentsStore.editComment(e)}onDeleteReplyComment(e){this.commentsStore.deleteReplyComment(e)}};o.\u0275fac=function(t){return new(t||o)},o.\u0275cmp=k({type:o,selectors:[["app-comments"]],standalone:!0,features:[M([b]),B],decls:2,vars:3,consts:[[1,"flex","flex-col","gap-5"],[3,"user"],[3,"submitComment","user"],[3,"delete","downVote","edit","reply","upVote","update","comment","myComment","isEditing"],[1,"flex","flex-row"],[1,"w-9","sm:w-[90px]","flex","sm:justify-center"],[1,"h-full","w-[2px]","bg-light-gray","dark:bg-dark-blue","border-0"],[3,"comment","myComment","isEditing"],[3,"deleteReply","downVote","edit","reply","upVote","update","comment","myComment","isEditing"]],template:function(t,n){if(t&1&&(x(0,ie,2,1,"div",0),z(1,"async")),t&2){let s;y((s=N(1,1,n.vm$))?0:-1,s)}},dependencies:[G,q,J,K],encapsulation:2,changeDetection:0});let m=o;return m})();export{Se as CommentsComponent};
